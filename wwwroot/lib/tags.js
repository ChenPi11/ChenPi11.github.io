"use strict";import{getTheme,addThemeChangeCallback}from"/lib/theme-loader.js";function updateTheme(theme){let title_icon="&#58114;";if(theme==="dark"){title_icon="&#58238;"}$(".tags-title").html(`${title_icon} 标签云 ${title_icon}`)}addThemeChangeCallback(updateTheme);$((function(){updateTheme(getTheme())}));function newTag(tagname){let hue=Math.floor(Math.random()*360);if(hue>=15&&hue<=135){hue+=200}const color=`hsl(${hue}, 100%, 50%)`;const tag=$(`\n        <a class="tag" style="background-color: ${color}"\n           href="#${tagname}" id="tag-${tagname}">\n            ${tagname}\n        </a>`);$(".tags").append(tag)}function newPost(link,title,date,desc){const post=$(`\n                <div class="post">\n                    <a href="${link}" class="postlink" target="_blank">\n                        <h2>${title}</h2>\n                        <p>Posted on <em>${date}</em></p>\n                        <p>${desc}</p>\n                    </a>\n                </div>`);$("#posts").append(post)}var posts=[];var meta=null;async function fetchPostsMeta(){const response=await fetch("/posts-meta.json");const posts=await response.json();return posts}async function initTagsAndPosts(){try{meta=await fetchPostsMeta();const tags=meta.tags;posts=meta.posts;for(const tag of Object.keys(tags)){newTag(tag)}}catch(exception){console.error(exception);$("#posts-hint").text("解析元数据失败");$("#posts").html(`<p>${exception.stack}`)}}var tagsPromise=initTagsAndPosts();async function onHashChange(){if(window.location.hash!==""){await tagsPromise;const tag=decodeURIComponent(window.location.hash.substring(1));$(".tag").removeClass("active");$(`#tag-${tag}`).addClass("active");console.log(`Querying for tag: ${JSON.stringify(tag)} ...`);try{if(meta===null){return}$("#posts").empty();for(const post of posts){if(post.tags.includes(tag)){newPost(post.link,post.title,post.date,post.desc)}}const postCount=meta.tags[tag];if(postCount===undefined||postCount==null||postCount===0){$("#posts-hint").text("没有找到相关文章");return}$("#posts-hint").text(`共 ${postCount} 篇文章`)}catch(exception){console.error(exception);$("#posts-hint").text("加载文章失败");$("#posts").html(`<p>${exception.stack}`)}}}$(onHashChange);$(window).on("hashchange",onHashChange);
