# -*- Makefile -*-

# Copyright (C) 2025 ChenPi11.
# This file is part of chenpi11-blog.
#
# chenpi11-blog is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# chenpi11-blog is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with chenpi11-blog.  If not, see <https://www.gnu.org/licenses/>.

srcdir = $(shell realpath -s "@srcdir@")
top_srcdir = $(shell realpath -s "@top_srcdir@")

PREFIX = @prefix@

SHELL ?= @SHELL@
MKDIR ?= mkdir -p
RM ?= rm -f
INSTALL = @install_sh@

XGETTEXT = @XGETTEXT@
FROMCODE = --from-code=UTF-8
PKG_INFO = --package-name=chenpi11-blog --package-version=0.1.0
KEYWORDS = --keyword=_ --keyword=_g
OUTPUT_FLAGS = --width=100
COMMENTS = --add-comments --add-location --strict
COPYRIGHT = --copyright-holder="2025 ChenPi11's Blog"
BUGS_ADDR = --msgid-bugs-address=wushengwuxi-msctinoulk@outlook.com
XGETTEXT_FLAGS = $(FROMCODE) $(PKG_INFO) $(KEYWORDS) $(OUTPUT_FLAGS) $(COMMENTS) $(COPYRIGHT) $(BUGS_ADDR)

SUPPORT_LANGS = $(shell ls *.po | sed 's/\.po//g')

.PHONY: all clean binclean allclean

all :

build-post.pot : $(wildcard $(top_srcdir)/src/*.c)
	cd $(top_srcdir)/src && $(XGETTEXT) $(XGETTEXT_FLAGS) --output=$(srcdir)/$@ --language=C $^

mkpostlists.pot : $(wildcard $(top_srcdir)/src/*.cpp)
	cd $(top_srcdir)/src && $(XGETTEXT) $(XGETTEXT_FLAGS) --output=$(srcdir)/$@ --language=C++ $^

python-part.pot : $(wildcard $(top_srcdir)/chenpi11_blog/*.py)
	cd $(top_srcdir)/chenpi11_blog && $(XGETTEXT) $(XGETTEXT_FLAGS) --output=$(srcdir)/$@ --language=Python $^

scripts.pot : $(wildcard $(top_srcdir)/scripts/*) $(top_srcdir)/autogen.sh
	cd $(top_srcdir)/scripts && $(XGETTEXT) $(XGETTEXT_FLAGS) --output=$(srcdir)/$@ --language=Shell $^

messages.pot : build-post.pot mkpostlists.pot python-part.pot scripts.pot
	msgcat $^ > $@

%.mo : %.po
	msgfmt $^ -o $@

install-% : %.mo
	$(MKDIR) $(DESTDIR)$(PREFIX)/share/locale/$*/LC_MESSAGES
	$(INSTALL) -m 0644 $< $(DESTDIR)$(PREFIX)/share/locale/$*/LC_MESSAGES/chenpi11-blog.mo

install : $(SUPPORT_LANGS:%=install-%)

clean :

binclean :

allclean : clean binclean
	$(RM) Makefile
	$(RM) *.pot
	$(RM) *.mo
